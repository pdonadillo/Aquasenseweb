<!-- this is user-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaSense - User Dashboard</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="user-dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .chart-controls select {
            padding: 8px 12px;
            border: 1px solid #d0dde8;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .chart-container {
            height: 320px;
            position: relative;
        }
        .empty-state {
            text-align: center;
            color: #888;
            padding: 2rem;
            font-style: italic;
        }
        .hidden {
            display: none;
        }
        /* Report Loading State */
        .report-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            color: #6b7280;
            min-height: 120px;
        }
        .report-loading.hidden {
            display: none;
        }
        .report-loading p {
            margin-top: 12px;
            font-size: 14px;
            color: #6b7280;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.online {
            background-color: #10b981;
            color: white;
        }
        .status-badge.offline {
            background-color: #6b7280;
            color: white;
        }
        .status-badge:not(.online):not(.offline) {
            background-color: #e5e7eb;
            color: #6b7280;
        }
    </style>
</head>
<body class="user-dashboard-body">
    <!-- Two-Column Layout Container -->
    <div class="dashboard-layout">
        
        <!-- Left Sidebar (Fixed) -->
        <aside class="dashboard-sidebar">
            <!-- Sidebar Header/Branding -->
            <div class="sidebar-header">
                <div class="brand">
                    <img
                        src="assets/images/logo/aquasence.logo.png"
                        alt="AquaSense Logo"
                        class="app-logo"
                    />
                    <span class="brand-text">AquaSense</span>
                </div>
            </div>
            
            <!-- User Profile Section -->
            <div class="sidebar-user">
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <div>
                        <div>Loading...</div>
                        <div>User Account</div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Menu -->
            <nav class="sidebar-nav">
                <a href="#dashboard" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#monitoring" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Monitoring</span>
                </a>
                <a href="#feeding" class="nav-link">
                    <i class="fas fa-utensils"></i>
                    <span>Feeding</span>
                </a>
                <a href="#reports" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
            </nav>
            
            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Right Main Content Area -->
        <main class="main-content user-dashboard-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="dashboard-section active">
            <div class="container">
                <!-- Dashboard Header -->
                <div class="dashboard-header user-dashboard-header">
                    <h1 class="dashboard-title user-dashboard-title">Welcome to Your Dashboard</h1>
                    <p class="dashboard-subtitle user-dashboard-subtitle">Monitor your aquaculture system in real-time</p>
                </div>
                
                <!-- Key Metrics Section -->
                <div class="section-header">
                    <h2>Key Metrics</h2>
                    <div class="stats-grid user-stats-grid">
                        <div class="stat-card user-stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Water Temperature</h3>
                                <p class="stat-value" id="waterTempStat">--°C</p>
                                <span class="stat-status" id="waterTempStatus">--</span>
                            </div>
                        </div>
                        
                        <div class="stat-card user-stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="stat-content">
                                <h3>pH Level</h3>
                                <p class="stat-value" id="phLevelStat">--</p>
                                <span class="stat-status" id="phLevelStatus">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Motor Control Toggle Button -->
                    <div style="margin-top: 1.5rem; width: calc((100% - 1.5rem) / 2); max-width: calc((100% - 1.5rem) / 2); min-width: 260px;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); border: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 1rem; color: #2c3e50; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-power-off"></i> Motor Control
                            </h4>
                            <button 
                                id="motorToggleBtn" 
                                onclick="toggleMotor()" 
                                style="width: 100%; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                            >
                                <i class="fas fa-power-off" id="motorToggleIcon"></i>
                                <span id="motorToggleText">Loading...</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Charts and Schedule Section -->
                <div class="section-header">
                    <h2>Analytics & Schedule</h2>
                    <div class="charts-grid user-charts-grid">
                        <div class="chart-card user-chart-card">
                            <h3>Live Sensor Readings</h3>
                            <div class="chart-controls">
                                <select id="liveChartMetric">
                                    <option value="temperature">Temperature (°C)</option>
                                    <option value="ph">pH Level</option>
                                    <option value="both">Both Sensors</option>
                                </select>
                            </div>
                            <div class="chart-container">
                                <canvas id="waterQualityChart"></canvas>
                            </div>
                            <p id="chartEmptyState" class="empty-state hidden">
                                Waiting for sensor data...
                            </p>
                        </div>
                        
                        <div class="chart-card user-chart-card">
                            <h3>Feeding Schedule</h3>
                            <div class="feeding-schedule user-feeding-schedule" id="feedingScheduleList">
                                <!-- Feeding schedule items will be loaded dynamically from Firestore -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Monitoring Section -->
        <section id="monitoring" class="monitoring-section">
            <div class="container">
                <div class="dashboard-header user-dashboard-header page-header">
                    <h1 class="page-title user-page-title">Water Quality Monitoring</h1>
                    <p class="page-subtitle">Real-time sensor readings and system alerts</p>
                </div>
                
                <div class="monitoring-grid user-monitoring-grid">
                    <div class="monitor-card user-monitor-card">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Real-time Sensors
                        </h3>
                        <div class="sensor-list user-sensor-list">
                            <div class="sensor-item user-sensor-item">
                                <i class="fas fa-thermometer-half"></i>
                                <span>Temperature</span>
                                <span class="sensor-value user-sensor-value" data-sensor="temperature" id="sensorTemperature">--°C</span>
                            </div>
                            <div class="sensor-item user-sensor-item">
                                <i class="fas fa-tint"></i>
                                <span>pH Level</span>
                                <span class="sensor-value user-sensor-value" data-sensor="ph" id="sensorPh">--</span>
                            </div>
                            <div class="sensor-item user-sensor-item">
                                <i class="fas fa-cog"></i>
                                <span>Feeder</span>
                                <span class="sensor-value user-sensor-value" data-sensor="feeder" id="sensorFeeder">
                                    <span class="status-badge" id="feederStatusBadge">--</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="monitor-card user-monitor-card">
                        <h3>
                            <i class="fas fa-bell"></i>
                            Alerts & Notifications
                        </h3>
                        <div class="alerts-list user-alerts-list">
                            <div class="alert-item info user-alert-item">
                                <i class="fas fa-info-circle"></i>
                                <p id="nextFeedingAlert">Loading next feeding schedule...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Production Monitoring Section -->
                <div class="production-monitoring">
                    <h2 class="production-monitoring-title">
                        <i class="fas fa-fish"></i>
                        Production Monitoring
                    </h2>
                    
                    <div class="production-monitoring-container">
                        <!-- Left Div - User Input -->
                        <div class="production-input-section">
                            <h3 class="section-subtitle">Input Values</h3>
                            <div class="production-form">
                                <div class="form-group">
                                    <label for="fingerlingsCount">
                                        <i class="fas fa-fish"></i>
                                        Fingerlings Count
                                    </label>
                                    <input 
                                        type="number" 
                                        id="fingerlingsCount" 
                                        name="fingerlingsCount"
                                        min="0" 
                                        step="1"
                                        placeholder="Enter fingerlings count"
                                        class="form-input"
                                    >
                                </div>
                                
                                <div class="form-group">
                                    <label for="harvestedCount">
                                        <i class="fas fa-check-circle"></i>
                                        Harvested Count
                                    </label>
                                    <input 
                                        type="number" 
                                        id="harvestedCount" 
                                        name="harvestedCount"
                                        min="0" 
                                        step="1"
                                        placeholder="Enter harvested count"
                                        class="form-input"
                                    >
                                </div>
                                
                                <div class="form-group">
                                    <label for="startMonth">
                                        <i class="fas fa-calendar-alt"></i>
                                        Start Month
                                    </label>
                                    <select id="startMonth" name="startMonth" class="form-input">
                                        <option value="">Select Start Month</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="endMonth">
                                        <i class="fas fa-calendar-check"></i>
                                        End Month
                                    </label>
                                    <select id="endMonth" name="endMonth" class="form-input">
                                        <option value="">Select End Month</option>
                                        <option value="01">January</option>
                                        <option value="02">February</option>
                                        <option value="03">March</option>
                                        <option value="04">April</option>
                                        <option value="05">May</option>
                                        <option value="06">June</option>
                                        <option value="07">July</option>
                                        <option value="08">August</option>
                                        <option value="09">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                </div>
                                
                                <button 
                                    type="button" 
                                    id="calculateProductionBtn" 
                                    class="btn-calculate-production"
                                    onclick="calculateProductionMetrics()"
                                >
                                    <i class="fas fa-calculator"></i>
                                    Calculate Production Metrics
                                </button>
                            </div>
                        </div>
                        
                        <!-- Right Div - Output Value -->
                        <div class="production-output-section">
                            <h3 class="section-subtitle">Output Value</h3>
                            <div class="production-output-content">
                                <div class="output-item">
                                    <span class="output-label">Fingerlings / Harvest:</span>
                                    <span class="output-value" id="fingerlingsHarvestRatio">--</span>
                                </div>
                                
                                <div class="output-item">
                                    <span class="output-label">Percentage:</span>
                                    <span class="output-value" id="survivalPercentage">--%</span>
                                </div>
                                
                                <div class="output-item profit">
                                    <span class="output-label">PROFIT VALUE:</span>
                                    <span class="output-value" id="profitValue">--%</span>
                                </div>
                                
                                <div class="output-item loss">
                                    <span class="output-label">LOSS VALUE:</span>
                                    <span class="output-value" id="lossValue">--%</span>
                                </div>
                                
                                <div class="output-item deaths">
                                    <span class="output-label">DEATHS VALUE:</span>
                                    <span class="output-value" id="deathsValue">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Feeding Section -->
        <section id="feeding" class="feeding-section">
            <div class="container">
                <div class="dashboard-header user-dashboard-header page-header">
                    <h1 class="page-title user-page-title">Feeding Management</h1>
                    <p class="page-subtitle">Schedule and manage automated feeding operations</p>
                </div>
                
                <div class="feeding-controls user-feeding-controls">
                    <!-- Motor Control Card -->
                    <div class="feeding-schedule-card user-feeding-schedule-card">
                        <h3>
                            <i class="fas fa-power-off"></i>
                            Motor Control
                        </h3>
                        <div style="padding: 1rem 0;">
                            <button 
                                id="feedingMotorToggleBtn" 
                                onclick="toggleMotor()" 
                                style="width: 100%; padding: 0.75rem 1.5rem; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;"
                            >
                                <i class="fas fa-power-off" id="feedingMotorToggleIcon"></i>
                                <span id="feedingMotorToggleText">Loading...</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Schedule Cards Container (Side by Side) -->
                    <div class="feeding-schedule-grid">
                        <!-- Add Schedule Form Card -->
                        <div class="feeding-schedule-card user-feeding-schedule-card">
                            <h3>
                                <i class="fas fa-plus-circle"></i>
                                Add Feeding Schedule
                            </h3>
                            <form class="feeding-form user-feeding-form" id="addFeedingScheduleForm" onsubmit="event.preventDefault(); addFeedingSchedule();">
                                <div class="form-group">
                                    <label for="scheduleTime">
                                        <i class="fas fa-clock"></i>
                                        Time
                                    </label>
                                    <input 
                                        type="time" 
                                        id="scheduleTime" 
                                        class="form-input" 
                                        required
                                        placeholder="Select time"
                                    >
                                </div>
                                <div class="form-group">
                                    <label for="scheduleDuration">
                                        <i class="fas fa-hourglass-half"></i>
                                        Duration (minutes)
                                    </label>
                                    <input 
                                        type="number" 
                                        id="scheduleDuration" 
                                        class="form-input" 
                                        min="1" 
                                        max="1440" 
                                        value="30" 
                                        required
                                        placeholder="Enter duration in minutes"
                                    >
                                </div>
                                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 0.5rem;">
                                    <i class="fas fa-plus"></i>
                                    Add Schedule
                                </button>
                            </form>
                        </div>
                        
                        <!-- Schedule List Card -->
                        <div class="feeding-schedule-card user-feeding-schedule-card">
                            <h3>
                                <i class="fas fa-clock"></i>
                                Schedule
                            </h3>
                            <div class="schedule-list user-schedule-list" id="recentFeedingList">
                                <!-- Recent feeding history will be loaded dynamically from Firestore -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="reports-section">
            <div class="container">
                <div class="dashboard-header user-dashboard-header page-header">
                    <h1 class="page-title user-page-title">Reports & Analytics</h1>
                    <p class="page-subtitle">View detailed summaries and historical data</p>
                </div>
                
                <div class="reports-container user-reports-container">
                    <!-- Hourly Summary Report -->
                    <div class="report-section user-report-section">
                        <div class="report-header user-report-header">
                            <h3>
                                <i class="fas fa-clock"></i>
                                Hourly Summary
                            </h3>
                        </div>
                        <!-- Date Selector for Hourly -->
                        <div class="date-selector-container" style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
                            <label for="hourlyDateSelector" style="font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-calendar-day"></i> Select Date:
                            </label>
                            <input type="date" id="hourlyDateSelector" style="padding: 0.5rem 1rem; border: 1px solid #d0dde8; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer;">
                        </div>
                        <div id="hourly-loading" class="report-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading hourly report...</p>
                        </div>
                        <div class="report-table-container user-report-table-container">
                            <table class="report-table user-report-table" id="hourlySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Hour</th>
                                        <th>Temperature (°C)</th>
                                        <th>pH</th>
                                    </tr>
                                </thead>
                                <tbody id="hourlySummaryTableBody">
                                    <!-- Loading state will be shown above, empty state shown here after fetch -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Hourly Charts -->
                        <div class="report-charts-container" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">Temperature Trend</h4>
                                <canvas id="hourlyTemperatureChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">pH Trend</h4>
                                <canvas id="hourlyPhChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Daily Summary Report -->
                    <div class="report-section user-report-section">
                        <div class="report-header user-report-header">
                            <h3>
                                <i class="fas fa-calendar-day"></i>
                                Daily Summary
                            </h3>
                        </div>
                        <!-- Month Selector for Daily/Weekly -->
                        <div class="month-selector-container" style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
                            <label for="reportMonthSelector" style="font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-calendar"></i> Select Month:
                            </label>
                            <input type="month" id="reportMonthSelector" style="padding: 0.5rem 1rem; border: 1px solid #d0dde8; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer;">
                        </div>
                            <div class="report-actions user-report-actions">
                                <button class="btn-export btn-export-excel" onclick="exportDailyReport('excel')" title="Export to Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn-export btn-export-word" onclick="exportDailyReport('word')" title="Export to Word">
                                    <i class="fas fa-file-word"></i> Word
                                </button>
                                <button class="btn-export btn-export-pdf" onclick="exportDailyReport('pdf')" title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div id="daily-loading" class="report-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading daily report...</p>
                        </div>
                        <div class="report-table-container user-report-table-container">
                            <table class="report-table user-report-table" id="dailySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Avg Temperature (°C)</th>
                                        <th>Avg pH</th>
                                        <th>Water Quality</th>
                                    </tr>
                                </thead>
                                <tbody id="dailySummaryTableBody">
                                    <!-- Loading state will be shown above, empty state shown here after fetch -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Daily Charts -->
                        <div class="report-charts-container" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">Temperature Trend</h4>
                                <canvas id="dailyTemperatureChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">pH Trend</h4>
                                <canvas id="dailyPhChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Weekly Summary Report -->
                    <div class="report-section user-report-section">
                        <div class="report-header user-report-header">
                            <h3>
                                <i class="fas fa-calendar-week"></i>
                                Weekly Summary
                            </h3>
                            <div class="report-actions user-report-actions">
                                <button class="btn-export btn-export-excel" onclick="exportWeeklyReport('excel')" title="Export to Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn-export btn-export-word" onclick="exportWeeklyReport('word')" title="Export to Word">
                                    <i class="fas fa-file-word"></i> Word
                                </button>
                                <button class="btn-export btn-export-pdf" onclick="exportWeeklyReport('pdf')" title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div id="weekly-loading" class="report-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading weekly report...</p>
                        </div>
                        <div class="report-table-container user-report-table-container">
                            <table class="report-table user-report-table" id="weeklySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Avg pH</th>
                                        <th>Avg Temperature (°C)</th>
                                        <th>Coverage Days</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklySummaryTableBody">
                                    <!-- Loading state will be shown above, empty state shown here after fetch -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Weekly Charts -->
                        <div class="report-charts-container" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">Temperature Trend</h4>
                                <canvas id="weeklyTemperatureChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">pH Trend</h4>
                                <canvas id="weeklyPhChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Summary Report -->
                    <div class="report-section user-report-section">
                        <div class="report-header user-report-header">
                            <h3>
                                <i class="fas fa-calendar-alt"></i>
                                Monthly Summary
                            </h3>
                        </div>
                        <!-- Year Selector for Monthly -->
                        <div class="year-selector-container" style="margin-bottom: 1rem; padding: 0.75rem; background: #f8fafc; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
                            <label for="reportYearSelector" style="font-weight: 600; color: #2c3e50;">
                                <i class="fas fa-calendar-alt"></i> Select Year:
                            </label>
                            <input type="number" id="reportYearSelector" min="2020" max="2100" style="padding: 0.5rem 1rem; border: 1px solid #d0dde8; border-radius: 8px; font-size: 1rem; background: white; cursor: pointer; width: 120px;">
                        </div>
                            <div class="report-actions user-report-actions">
                                <button class="btn-export btn-export-excel" onclick="exportMonthlyReport('excel')" title="Export to Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn-export btn-export-word" onclick="exportMonthlyReport('word')" title="Export to Word">
                                    <i class="fas fa-file-word"></i> Word
                                </button>
                                <button class="btn-export btn-export-pdf" onclick="exportMonthlyReport('pdf')" title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div id="monthly-loading" class="report-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading monthly report...</p>
                        </div>
                        <div class="report-table-container user-report-table-container">
                            <table class="report-table user-report-table" id="monthlySummaryTable">
                                <thead>
                                    <tr>
                                        <th>Month</th>
                                        <th>Avg pH</th>
                                        <th>Avg Temperature (°C)</th>
                                        <th>Coverage Days</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlySummaryTableBody">
                                    <!-- Loading state will be shown above, empty state shown here after fetch -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Monthly Charts -->
                        <div class="report-charts-container" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">Temperature Trend</h4>
                                <canvas id="monthlyTemperatureChart"></canvas>
                            </div>
                            <div class="chart-wrapper">
                                <h4 style="margin-bottom: 1rem; color: #2c3e50;">pH Trend</h4>
                                <canvas id="monthlyPhChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Production Records Report (Harvest Mortality Log) -->
                    <div class="report-section user-report-section">
                        <div class="report-header user-report-header">
                            <h3>
                                <i class="fas fa-chart-line"></i>
                                Production Records
                            </h3>
                            <div class="report-actions user-report-actions">
                                <button class="btn-export btn-export-excel" onclick="exportProductionRecordsReport('excel')" title="Export to Excel">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                                <button class="btn-export btn-export-word" onclick="exportProductionRecordsReport('word')" title="Export to Word">
                                    <i class="fas fa-file-word"></i> Word
                                </button>
                                <button class="btn-export btn-export-pdf" onclick="exportProductionRecordsReport('pdf')" title="Export to PDF">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div id="production-loading" class="report-loading hidden">
                            <div class="spinner"></div>
                            <p>Loading production records...</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-top: 1.5rem;">
                            <!-- Production Records Table -->
                            <div class="report-table-container user-report-table-container">
                                <table class="report-table user-report-table" id="productionRecordsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAllSeasons" checked onchange="handleSelectAllSeasons()" style="cursor: pointer; width: 18px; height: 18px;" title="Select All Seasons">
                                            </th>
                                            <th>Date</th>
                                            <th>Start Month</th>
                                            <th>End Month</th>
                                            <th>Fingerlings</th>
                                            <th>Harvested</th>
                                            <th>Survival %</th>
                                            <th>Profit %</th>
                                            <th>Loss %</th>
                                            <th>Deaths</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productionRecordsTableBody">
                                        <tr>
                                            <td colspan="10" class="no-data-text">Loading production records...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Output Value Card (Matches Production Monitoring) -->
                            <div class="production-output-section">
                                <h3 class="section-subtitle">Output Value</h3>
                                <div class="production-output-content">
                                    <div class="output-item">
                                        <span class="output-label">Fingerlings / Harvest:</span>
                                        <span class="output-value" id="reportFingerlingsHarvest">--</span>
                                    </div>
                                    
                                    <div class="output-item">
                                        <span class="output-label">Percentage:</span>
                                        <span class="output-value" id="reportSurvivalPercentage">--%</span>
                                    </div>
                                    
                                    <div class="output-item profit">
                                        <span class="output-label">PROFIT VALUE:</span>
                                        <span class="output-value" id="reportProfitValue">--%</span>
                                    </div>
                                    
                                    <div class="output-item loss">
                                        <span class="output-label">LOSS VALUE:</span>
                                        <span class="output-value" id="reportLossValue">--%</span>
                                    </div>
                                    
                                    <div class="output-item deaths">
                                        <span class="output-label">DEATHS VALUE:</span>
                                        <span class="output-value" id="reportDeathsValue">--</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        </main>
    </div>

    <script type="module" src="firebase-init.js"></script>
    <script type="module" src="main.js"></script>
    
    <!-- Background runtime bootstrap: Ensures feeding schedules, RTDB listeners, and data sync always run -->
    <script type="module">
        import { 
            bootRuntimeCore, 
            writeHourlyFromRTDB, 
            startHourlySampler,
            runRollupsForCurrentContext
        } from './dashboard.js';
        
        // Boot runtime core (idempotent - safe to call multiple times)
        // This handles: device setup, RTDB listeners, feeding schedules, rollups
        bootRuntimeCore({sourcePage: 'user-dashboard'});
        
        // Additional background tasks that run continuously
        (async function startBackgroundRuntime() {
            // Wait for Firebase to initialize
            await new Promise(resolve => {
                if (window.RUNTIME_CONTEXT) {
                    resolve();
                } else {
                    // Poll for runtime context (max 10 seconds)
                    let attempts = 0;
                    const checkInterval = setInterval(() => {
                        attempts++;
                        if (window.RUNTIME_CONTEXT || attempts > 20) {
                            clearInterval(checkInterval);
                            resolve();
                        }
                    }, 500);
                }
            });
            
            // Start hourly RTDB to Firestore sync (runs every 5 minutes)
            // This ensures sensor data from RTDB is written to Firestore hourly records
            if (!window.__HOURLY_WRITE_TIMER__) {
                window.__HOURLY_WRITE_TIMER__ = setInterval(async () => {
                    try {
                        const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                        if (uid) {
                            console.log('[BACKGROUND] Writing hourly data from RTDB to Firestore');
                            await writeHourlyFromRTDB(uid).catch(err => {
                                console.error('[BACKGROUND] Hourly write error:', err);
                            });
                        }
                    } catch (error) {
                        console.error('[BACKGROUND] Hourly write timer error:', error);
                    }
                }, 5 * 60 * 1000); // Every 5 minutes
                
                // Run immediately on first load (after a short delay for RTDB data to populate)
                setTimeout(async () => {
                    const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                    if (uid) {
                        await writeHourlyFromRTDB(uid).catch(err => {
                            console.error('[BACKGROUND] Initial hourly write error:', err);
                        });
                    }
                }, 10000); // Wait 10 seconds for RTDB data to populate
                
                console.log('[BACKGROUND] Hourly RTDB→Firestore sync started');
            }
            
            // Start hourly sampler (runs every 5 minutes)
            if (!window.__HOURLY_SAMPLER_STARTED__) {
                const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                if (uid) {
                    startHourlySampler(uid);
                    window.__HOURLY_SAMPLER_STARTED__ = true;
                    console.log('[BACKGROUND] Hourly sampler started');
                } else {
                    // Retry when runtime context is available
                    const retryInterval = setInterval(() => {
                        const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                        if (uid) {
                            clearInterval(retryInterval);
                            startHourlySampler(uid);
                            window.__HOURLY_SAMPLER_STARTED__ = true;
                            console.log('[BACKGROUND] Hourly sampler started (retry)');
                        }
                    }, 2000);
                }
            }
            
            // Run rollups periodically (every 10 minutes)
            if (!window.__ROLLUP_TIMER__) {
                window.__ROLLUP_TIMER__ = setInterval(async () => {
                    try {
                        const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                        if (uid) {
                            console.log('[BACKGROUND] Running rollups');
                            await runRollupsForCurrentContext().catch(err => {
                                console.error('[BACKGROUND] Rollup error:', err);
                            });
                        }
                    } catch (error) {
                        console.error('[BACKGROUND] Rollup timer error:', error);
                    }
                }, 10 * 60 * 1000); // Every 10 minutes
                
                // Run immediately on first load
                setTimeout(async () => {
                    const uid = window.RUNTIME_CONTEXT?.runtimeUid || null;
                    if (uid) {
                        await runRollupsForCurrentContext().catch(err => {
                            console.error('[BACKGROUND] Initial rollup error:', err);
                        });
                    }
                }, 15000); // Wait 15 seconds for data to be available
                
                console.log('[BACKGROUND] Rollup timer started');
            }
            
            console.log('[BACKGROUND] User dashboard background runtime fully initialized');
        })();
    </script>
    
    <!-- Production Monitoring Calculation Script -->
    <script>
        /**
         * Calculate Production Metrics
         * Client-side calculation for production monitoring
         */
        function calculateProductionMetrics() {
            // Get input values
            const fingerlingsInput = document.getElementById('fingerlingsCount');
            const harvestedInput = document.getElementById('harvestedCount');
            const startMonthSelect = document.getElementById('startMonth');
            const endMonthSelect = document.getElementById('endMonth');
            
            const fingerlings = parseFloat(fingerlingsInput.value) || 0;
            const harvested = parseFloat(harvestedInput.value) || 0;
            const startMonth = startMonthSelect.value;
            const endMonth = endMonthSelect.value;
            
            // Validation
            if (fingerlings <= 0) {
                alert('Please enter a valid fingerlings count greater than 0.');
                fingerlingsInput.focus();
                return;
            }
            
            if (harvested > fingerlings) {
                alert('Harvested count cannot be greater than fingerlings count.');
                harvestedInput.focus();
                return;
            }
            
            if (harvested < 0) {
                alert('Harvested count cannot be negative.');
                harvestedInput.focus();
                return;
            }
            
            // Calculate metrics
            const deaths = fingerlings - harvested;
            const survivalPercentage = (harvested / fingerlings) * 100;
            const lossPercentage = 100 - survivalPercentage;
            
            // Calculate ratio (Fingerlings / Harvest)
            const ratio = harvested > 0 ? (fingerlings / harvested).toFixed(2) : '--';
            
            // Update output values
            document.getElementById('fingerlingsHarvestRatio').textContent = ratio;
            document.getElementById('survivalPercentage').textContent = survivalPercentage.toFixed(2) + '%';
            document.getElementById('profitValue').textContent = survivalPercentage.toFixed(2) + '%';
            document.getElementById('lossValue').textContent = lossPercentage.toFixed(2) + '%';
            document.getElementById('deathsValue').textContent = deaths.toFixed(0);
            
            // Automatically write to Firestore when button is clicked (after calculation succeeds)
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const startMonthName = startMonth ? (monthNames[parseInt(startMonth) - 1] || startMonth) : 'Not specified';
            const endMonthName = endMonth ? (monthNames[parseInt(endMonth) - 1] || endMonth) : 'Not specified';
            
            // Get UID from sessionStorage (standard pattern in this app)
            const uid = sessionStorage.getItem('userUid');
            if (uid && window.recordProductionMetrics) {
                // Automatically save to Firestore
                window.recordProductionMetrics(uid, {
                    fingerlingsCount: fingerlings,
                    harvestedCount: harvested,
                    deathsCount: deaths,
                    survivalRate: parseFloat(survivalPercentage.toFixed(2)),
                    lossRate: parseFloat(lossPercentage.toFixed(2)),
                    profitRate: parseFloat(survivalPercentage.toFixed(2)),
                    startMonth: startMonthName,
                    endMonth: endMonthName
                }).catch(err => {
                    console.error('[PRODUCTION] Failed to save metrics to Firestore:', err);
                });
            } else if (!uid) {
                console.warn('[PRODUCTION] No user UID found, cannot save to Firestore');
            } else if (!window.recordProductionMetrics) {
                console.warn('[PRODUCTION] recordProductionMetrics function not available. Make sure dashboard.js is loaded.');
            }
        }
        
        // Make function globally accessible
        window.calculateProductionMetrics = calculateProductionMetrics;
    </script>
</body>
</html>

 